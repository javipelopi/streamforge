# Story 3.8: Manage Orphan Xtream Channels

Status: ready-for-dev

## Story

As a user,
I want to see Xtream channels that don't match any XMLTV channel,
So that I can decide whether to add them to my Plex lineup with placeholder EPG.

## Acceptance Criteria

1. **Given** the Channels view
   **When** I scroll to the "Unmatched Xtream Streams" section
   **Then** I see all Xtream channels not matched to any XMLTV channel
   **And** each shows: stream name, quality tier, category

2. **Given** an orphan Xtream channel
   **When** I click "Promote to Plex"
   **Then** a dialog appears with fields:
   - Display name (pre-filled from Xtream name)
   - Channel icon URL (pre-filled from Xtream if available)
   **And** I can confirm to create a synthetic channel entry

3. **Given** I promote an orphan Xtream channel
   **When** the promotion completes
   **Then** a synthetic `xmltv_channels` entry is created with `is_synthetic = true`
   **And** a `channel_mappings` entry links it to the Xtream stream
   **And** placeholder EPG is generated (2-hour looping blocks)
   **And** the channel moves to the main XMLTV channel list

4. **Given** a synthetic channel exists
   **When** EPG refresh runs
   **Then** placeholder EPG is regenerated for the next 7 days
   **And** each block shows: "{Channel Name} - Live Programming"

5. **Given** a synthetic channel
   **When** I view it in the Channels list
   **Then** it shows a "Synthetic" badge to distinguish from real XMLTV channels
   **And** I can edit its display name and icon

## Tasks / Subtasks

### Database Migration

- [ ] Task 1: Add `is_synthetic` column to `xmltv_channels` table (AC: #3, #5)
  - [ ] 1.1 Create new Diesel migration: `2026XXXXXX_add_synthetic_flag`
  - [ ] 1.2 Add column: `is_synthetic INTEGER DEFAULT 0`
  - [ ] 1.3 Run migration: `diesel migration run`
  - [ ] 1.4 Update `src-tauri/src/db/schema.rs` (auto-generated by diesel)
  - [ ] 1.5 Update `src-tauri/src/db/models.rs` - add `is_synthetic` to XmltvChannel model

### Backend Commands

- [ ] Task 2: Create `get_orphan_xtream_streams` command (AC: #1)
  - [ ] 2.1 Add command in `src-tauri/src/commands/xmltv_channels.rs`
  - [ ] 2.2 Query: SELECT from xtream_channels WHERE id NOT IN (SELECT DISTINCT xtream_channel_id FROM channel_mappings)
  - [ ] 2.3 Return `Vec<OrphanXtreamStream>` with: id, streamId, name, streamIcon, qualities, categoryName
  - [ ] 2.4 Register command in `src-tauri/src/lib.rs`

- [ ] Task 3: Create `promote_orphan_to_plex` command (AC: #2, #3)
  - [ ] 3.1 Add command accepting: `xtream_channel_id`, `display_name`, `icon_url`
  - [ ] 3.2 Create synthetic `xmltv_channels` entry with:
    - `source_id`: Use -1 or create special "synthetic" source
    - `channel_id`: Generate unique ID like `synthetic-{xtream_channel_id}`
    - `display_name`: From user input
    - `icon`: From user input
    - `is_synthetic`: 1 (true)
  - [ ] 3.3 Create `channel_mappings` entry linking synthetic to Xtream stream
    - `xmltv_channel_id`: New synthetic channel ID
    - `xtream_channel_id`: The promoted stream ID
    - `match_confidence`: 1.0 (manual promotion)
    - `is_manual`: 1
    - `is_primary`: 1
    - `stream_priority`: 0
  - [ ] 3.4 Create `xmltv_channel_settings` entry with `is_enabled = 0` (user enables manually)
  - [ ] 3.5 Generate initial placeholder EPG (call generate_placeholder_epg)
  - [ ] 3.6 Return the newly created `XmltvChannelWithMappings`

- [ ] Task 4: Create `generate_placeholder_epg` function (AC: #3, #4)
  - [ ] 4.1 Add helper function in `src-tauri/src/commands/epg.rs` or new `synthetic.rs`
  - [ ] 4.2 Generate 7 days of 2-hour program blocks
  - [ ] 4.3 Each program: title = "{Channel Name} - Live Programming", no description
  - [ ] 4.4 Start times: every 2 hours from current hour
  - [ ] 4.5 Insert into `programs` table with `xmltv_channel_id` = synthetic channel ID

- [ ] Task 5: Update EPG refresh to regenerate synthetic channel EPG (AC: #4)
  - [ ] 5.1 Modify EPG refresh logic in `src-tauri/src/commands/epg.rs`
  - [ ] 5.2 After normal EPG refresh, find all channels with `is_synthetic = true`
  - [ ] 5.3 Delete old programs for synthetic channels
  - [ ] 5.4 Call `generate_placeholder_epg` for each synthetic channel

- [ ] Task 6: Create `update_synthetic_channel` command (AC: #5)
  - [ ] 6.1 Add command accepting: `channel_id`, `display_name`, `icon_url`
  - [ ] 6.2 Validate channel exists and `is_synthetic = true`
  - [ ] 6.3 Update `display_name` and `icon` in `xmltv_channels` table
  - [ ] 6.4 Update placeholder EPG with new channel name
  - [ ] 6.5 Return updated `XmltvChannelWithMappings`

- [ ] Task 7: Update `get_xmltv_channels_with_mappings` to include `is_synthetic` (AC: #5)
  - [ ] 7.1 Remove TODO comment at line 187-188 of `xmltv_channels.rs`
  - [ ] 7.2 Read `is_synthetic` from database (handle NULL as false for backwards compat)
  - [ ] 7.3 Already returns `is_synthetic` in response type (frontend ready)

### Frontend Components

- [ ] Task 8: Create `OrphanXtreamSection` component (AC: #1)
  - [ ] 8.1 Create `src/components/channels/OrphanXtreamSection.tsx`
  - [ ] 8.2 Section header: "Unmatched Xtream Streams" with count
  - [ ] 8.3 Collapsible section (default collapsed if many orphans)
  - [ ] 8.4 List each orphan with: name, quality badges, category
  - [ ] 8.5 Add "Promote to Plex" button on each row
  - [ ] 8.6 Add data-testid="orphan-xtream-section" for E2E tests

- [ ] Task 9: Create `PromoteToPlexDialog` component (AC: #2)
  - [ ] 9.1 Create `src/components/channels/PromoteToPlexDialog.tsx`
  - [ ] 9.2 Use Radix Dialog for accessible modal
  - [ ] 9.3 Fields:
    - Display name (text input, pre-filled from Xtream name)
    - Channel icon URL (text input, pre-filled from Xtream icon if available)
    - Preview of icon if URL is valid
  - [ ] 9.4 Buttons: "Cancel" and "Promote to Plex" (primary)
  - [ ] 9.5 Form validation: display name required, icon URL optional
  - [ ] 9.6 Add data-testid="promote-dialog" for E2E tests

- [ ] Task 10: Add TypeScript bindings (AC: #1, #2, #3)
  - [ ] 10.1 Add `OrphanXtreamStream` interface to `src/lib/tauri.ts`
  - [ ] 10.2 Add `getOrphanXtreamStreams(): Promise<OrphanXtreamStream[]>`
  - [ ] 10.3 Add `promoteOrphanToPlex(xtreamChannelId, displayName, iconUrl): Promise<XmltvChannelWithMappings>`
  - [ ] 10.4 Add `updateSyntheticChannel(channelId, displayName, iconUrl): Promise<XmltvChannelWithMappings>`

- [ ] Task 11: Integrate OrphanXtreamSection into Channels view (AC: #1)
  - [ ] 11.1 Import OrphanXtreamSection in `src/views/Channels.tsx`
  - [ ] 11.2 Add useQuery for `getOrphanXtreamStreams`
  - [ ] 11.3 Render section below main XMLTV channel list
  - [ ] 11.4 Add mutation for `promoteOrphanToPlex`
  - [ ] 11.5 On promote success: invalidate both orphans query and xmltv-channels query

- [ ] Task 12: Display "Synthetic" badge on synthetic channels (AC: #5)
  - [ ] 12.1 Modify `DraggableChannelRow.tsx` to check `channel.isSynthetic`
  - [ ] 12.2 Render badge: `<span className="px-2 py-0.5 text-xs font-medium bg-orange-100 text-orange-800 rounded-full">Synthetic</span>`
  - [ ] 12.3 Position badge after channel name

- [ ] Task 13: Add edit capability for synthetic channels (AC: #5)
  - [ ] 13.1 Add "Edit" button on synthetic channel rows (only show if `isSynthetic = true`)
  - [ ] 13.2 Reuse `PromoteToPlexDialog` with edit mode
  - [ ] 13.3 On edit success: invalidate xmltv-channels query

### Testing

- [ ] Task 14: Testing and verification
  - [ ] 14.1 Run `cargo check` - verify no Rust errors
  - [ ] 14.2 Run `npx tsc --noEmit` - verify TypeScript compiles
  - [ ] 14.3 Run `cargo test` - all Rust tests pass
  - [ ] 14.4 Create E2E tests in `tests/e2e/orphan-channels.spec.ts`
  - [ ] 14.5 E2E test: Orphan section shows unmatched streams (AC #1)
  - [ ] 14.6 E2E test: Promote dialog opens with pre-filled values (AC #2)
  - [ ] 14.7 E2E test: Promoting creates synthetic channel (AC #3)
  - [ ] 14.8 E2E test: Synthetic badge displays correctly (AC #5)
  - [ ] 14.9 E2E test: Edit synthetic channel works (AC #5)

## Dev Notes

### CRITICAL: Architecture Compliance

**XMLTV-First Design:** XMLTV channels are the PRIMARY channel list for Plex. "Orphan" Xtream streams are those not matched to any XMLTV channel. When promoted, they become "synthetic" XMLTV channels with placeholder EPG data.

**From PRD FR26a:**
> FR26a: User can view all channels from all sources (XMLTV and Xtream) in the Channels tab, with icons indicating source type and match relationships. The XMLTV channel list defines the Plex lineup; Xtream streams are the video sources matched to those channels

[Source: _bmad-output/planning-artifacts/prd.md#Functional Requirements]

### Database Schema Changes

**Migration Required: Add `is_synthetic` column**

The current `xmltv_channels` table does NOT have an `is_synthetic` column. The code has a TODO at line 187-188 in `xmltv_channels.rs`:
```rust
// TODO: is_synthetic field not in DB schema yet - defaults to false
is_synthetic: false,
```

**New Migration:**
```sql
-- up.sql
ALTER TABLE xmltv_channels ADD COLUMN is_synthetic INTEGER DEFAULT 0;

-- down.sql
-- SQLite doesn't support DROP COLUMN easily; recreate table approach:
CREATE TABLE xmltv_channels_backup AS SELECT id, source_id, channel_id, display_name, icon, created_at, updated_at FROM xmltv_channels;
DROP TABLE xmltv_channels;
ALTER TABLE xmltv_channels_backup RENAME TO xmltv_channels;
```

**Note:** SQLite has limited ALTER TABLE support. The down migration is complex. Consider if rollback is truly needed or if the column can simply be ignored in down migration.

[Source: _bmad-output/planning-artifacts/architecture.md#Database Schema]

### Existing Schema Reference

**Current Tables (from `schema.rs`):**

```rust
diesel::table! {
    xmltv_channels (id) {
        id -> Nullable<Integer>,
        source_id -> Integer,
        channel_id -> Text,
        display_name -> Text,
        icon -> Nullable<Text>,
        created_at -> Text,
        updated_at -> Text,
        // MISSING: is_synthetic -> Integer (need migration)
    }
}

diesel::table! {
    xtream_channels (id) {
        id -> Nullable<Integer>,
        account_id -> Integer,
        stream_id -> Integer,
        name -> Text,
        stream_icon -> Nullable<Text>,
        category_id -> Nullable<Integer>,
        category_name -> Nullable<Text>,
        qualities -> Nullable<Text>,
        epg_channel_id -> Nullable<Text>,
        // ... other fields
    }
}

diesel::table! {
    channel_mappings (id) {
        id -> Nullable<Integer>,
        xmltv_channel_id -> Integer,
        xtream_channel_id -> Integer,
        match_confidence -> Nullable<Float>,
        is_manual -> Nullable<Integer>,
        is_primary -> Nullable<Integer>,
        stream_priority -> Nullable<Integer>,
        created_at -> Text,
    }
}

diesel::table! {
    programs (id) {
        id -> Nullable<Integer>,
        xmltv_channel_id -> Integer,
        title -> Text,
        description -> Nullable<Text>,
        start_time -> Text,
        end_time -> Text,
        category -> Nullable<Text>,
        episode_info -> Nullable<Text>,
        created_at -> Text,
    }
}
```

[Source: src-tauri/src/db/schema.rs]

### Existing Code to Leverage

**Backend - `src-tauri/src/commands/xmltv_channels.rs`:**
- `XmltvChannelWithMappings` struct already has `is_synthetic: bool` field (line 42)
- `get_xmltv_channels_with_mappings` - Query pattern for loading channels with mappings
- `build_stream_match` helper - Reuse for building match objects
- `parse_qualities` helper - Reuse for quality tier parsing

**Backend - `src-tauri/src/db/models.rs`:**
- `XmltvChannel` struct - Add `is_synthetic: Option<i32>` field
- `NewXmltvChannel` struct - Add `is_synthetic` for insert operations

**Frontend - `src/lib/tauri.ts`:**
- `XmltvChannelWithMappings` already has `isSynthetic: boolean` field (line 658)
- `XtreamStreamSearchResult` - Pattern for orphan stream response type
- `addManualStreamMapping` - Pattern for promotion mutation

**Frontend - `src/views/Channels.tsx`:**
- TanStack Query patterns for data fetching
- useMutation patterns for write operations
- Toast notification system

**Frontend - `src/components/channels/DraggableChannelRow.tsx`:**
- Channel row component to add Synthetic badge
- Already displays icons, toggle, etc.

### Synthetic Channel Source ID Strategy

**Option A: Use `-1` as source_id for synthetic channels**
- Simple, no additional tables needed
- Foreign key constraint may fail if `source_id` references `xmltv_sources(id)`

**Option B: Create a special "Synthetic" source**
- Insert a permanent record: `INSERT INTO xmltv_sources (name, url, ...) VALUES ('Synthetic', 'synthetic://local', ...)`
- Use that source_id for all synthetic channels
- More database-correct approach

**Recommendation:** Option B - Create synthetic source in migration or on first use.

### Placeholder EPG Generation Logic

```rust
/// Generate 7 days of placeholder EPG for a synthetic channel
fn generate_placeholder_epg(
    conn: &mut SqliteConnection,
    xmltv_channel_id: i32,
    channel_name: &str,
) -> Result<(), diesel::result::Error> {
    use crate::db::schema::programs;

    let now = chrono::Utc::now();
    let start_of_hour = now.with_minute(0).unwrap().with_second(0).unwrap();

    let mut programs_to_insert = Vec::new();

    // Generate 7 days worth of 2-hour blocks
    // 7 days * 12 blocks/day = 84 programs
    for block in 0..(7 * 12) {
        let start = start_of_hour + chrono::Duration::hours(block * 2);
        let end = start + chrono::Duration::hours(2);

        programs_to_insert.push(NewProgram {
            xmltv_channel_id,
            title: format!("{} - Live Programming", channel_name),
            description: None,
            start_time: start.to_rfc3339(),
            end_time: end.to_rfc3339(),
            category: Some("Live".to_string()),
            episode_info: None,
        });
    }

    diesel::insert_into(programs::table)
        .values(&programs_to_insert)
        .execute(conn)?;

    Ok(())
}
```

### Previous Story Intelligence (Story 3-7)

**Key Patterns Established:**
1. **ARIA live regions** for accessibility - ADD to promote success/error
2. **Input validation** on both frontend and backend - VALIDATE display_name non-empty
3. **Optimistic UI updates** - APPLY to promotion (add to list immediately)
4. **Toast notifications** for success/error feedback - REUSE

**Code Review Learnings:**
- Remove console.log/console.error before completion
- Add accessibility attributes (ARIA labels on buttons)
- Add input validation for edge cases
- Consider performance limits (large orphan lists)

### Git Intelligence

**Recent Commits Pattern:**
```
9a23001 Code review fixes for story 3-7
a628fc1 Implement story 3-7
590897b Generate ATDD failing tests for story 3-7
cd48018 Create story 3-7
```

**Established Workflow:**
1. Create story file (this document)
2. Generate ATDD tests (failing)
3. Implement features
4. Code review fixes

### Project Structure Notes

**Files to Create:**
- `src-tauri/migrations/20260120XXXXXX_add_synthetic_flag/up.sql`
- `src-tauri/migrations/20260120XXXXXX_add_synthetic_flag/down.sql`
- `src/components/channels/OrphanXtreamSection.tsx`
- `src/components/channels/PromoteToPlexDialog.tsx`
- `tests/e2e/orphan-channels.spec.ts`

**Files to Modify:**
- `src-tauri/src/db/schema.rs` - Auto-generated after migration
- `src-tauri/src/db/models.rs` - Add `is_synthetic` field to XmltvChannel
- `src-tauri/src/commands/xmltv_channels.rs` - New commands, fix TODO
- `src-tauri/src/commands/epg.rs` - Placeholder EPG generation, refresh integration
- `src-tauri/src/lib.rs` - Register new commands
- `src/lib/tauri.ts` - Add TypeScript bindings
- `src/views/Channels.tsx` - Integrate orphan section
- `src/components/channels/DraggableChannelRow.tsx` - Add Synthetic badge
- `src/components/channels/index.ts` - Export new components

### Testing Requirements

**Rust Unit Tests:**
- Test orphan detection query (channels not in any mapping)
- Test synthetic channel creation with is_synthetic = true
- Test placeholder EPG generation (correct number of blocks, time spans)
- Test promotion idempotency (can't promote same stream twice)

**E2E Tests (Playwright):**
- Test orphan section displays when orphans exist
- Test orphan section hidden when no orphans
- Test promote dialog opens with pre-filled values
- Test promote creates synthetic channel
- Test synthetic channel appears in main list with badge
- Test edit dialog for synthetic channel
- Test promotion error handling (network failure)

### Performance Considerations

- **Orphan Query Efficiency:** Use NOT IN subquery or LEFT JOIN WHERE NULL pattern
- **Batch EPG Insert:** Insert all 84 programs in single transaction
- **Orphan Section Collapse:** Default collapsed if > 20 orphans to reduce DOM
- **Virtualization:** If orphan list is very large, consider TanStack Virtual

### Accessibility Requirements

- Promote button: `aria-label="Promote {stream name} to Plex lineup"`
- Dialog: Proper focus management via Radix Dialog
- Badge: Screen reader text for "Synthetic" status
- Edit button: `aria-label="Edit synthetic channel {channel name}"`
- ARIA live region for promotion success announcement

### Error Handling

- **Duplicate Promotion:** Check if Xtream stream already has a mapping before promotion
- **Database Transaction:** Wrap promotion in transaction (create channel + mapping + EPG)
- **EPG Generation Failure:** Log error but don't fail promotion
- **Invalid Icon URL:** Allow empty/invalid URLs, display fallback icon

### References

- [Source: _bmad-output/planning-artifacts/architecture.md#Database Schema]
- [Source: _bmad-output/planning-artifacts/architecture.md#Frontend (React)]
- [Source: _bmad-output/planning-artifacts/prd.md#FR26a]
- [Source: _bmad-output/planning-artifacts/epics.md#Story 3.8]
- [Source: src-tauri/src/commands/xmltv_channels.rs - existing patterns]
- [Source: src-tauri/src/db/schema.rs - current schema]
- [Source: src/lib/tauri.ts - TypeScript binding patterns]
- [Source: src/views/Channels.tsx - view integration patterns]

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

### Completion Notes List

### File List
